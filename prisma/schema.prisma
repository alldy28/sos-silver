generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model SossilverProduct {
  id             String          @id @default(cuid())
  nama           String
  series         String?
  gramasi        Float
  fineness       Int
  hargaJual      Int
  hargaBuyback   Int
  tahunPembuatan Int?
  gambarUrl      String?
  createdAt      DateTime        @default(now())
  codes          GeneratedCode[]
  invoiceItems   InvoiceItem[]
}

model GeneratedCode {
  id           String           @id @default(cuid())
  kode         String           @unique
  sequentialId Int?
  isUsed       Boolean          @default(false)
  createdAt    DateTime         @default(now())
  productId    String
  product      SossilverProduct @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model User {
  id                String    @id @default(cuid())
  email             String    @unique
  password          String
  name              String?
  
  // [SEMPURNA] Kolom untuk Role dan Verifikasi
  role              Role      @default(CUSTOMER)
  emailVerified     DateTime?
  verificationToken String?   @unique

  resetPasswordToken String? @unique
  resetPasswordExpires DateTime?

  resetPasswordAttempts Int       @default(0)
  resetPasswordLastAttempt DateTime?

  // --- [BARU] Field Affiliate ---
  isAffiliate   Boolean   @default(false) // Apakah user ini affiliate?
  affiliateCode String?   @unique         // Kode unik (misal: 'ALDI123')
  
  // Relasi Komisi (Uang yang didapat)
  commissions   AffiliateCommission[]
  
  // [BARU] Relasi Payout (Permintaan Pencairan)
  payouts       PayoutRequest[] 

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt @default(now())

  // [SEMPURNA] Relasi 1: Invoice yang DIBUAT oleh Admin
  createdInvoices Invoice[] @relation("AdminCreator")
  
  // [SEMPURNA] Relasi 2: Order yang DIMILIKI oleh Customer
  orders          Invoice[] @relation("CustomerOwner")

  // [BARU] Invoice yang direferensikan oleh user ini (sebagai Affiliate)
  referredInvoices Invoice[] @relation("AffiliateReferral")
}

model PriceImage {
  id       String @id @default("current_price_list")
  imageUrl String
}

model AffiliateCommission {
  id          String   @id @default(cuid())
  amount      Int      // Jumlah komisi (Rupiah)
  percentage  Float    // Persentase yang dipakai (2.5%)
  
  // Relasi ke Affiliate (User)
  affiliateId String
  affiliate   User     @relation(fields: [affiliateId], references: [id])
  
  // Relasi ke Invoice asal komisi
  invoiceId   String   @unique
  invoice     Invoice  @relation(fields: [invoiceId], references: [id])

  createdAt   DateTime @default(now())
}

model PromoSlide {
  id             String   @id @default(cuid())
  imageUrl       String
  destinationUrl String?
  order          Int
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([order])
}

model Invoice {
  id              String   @id @default(cuid())
  // ... (field invoiceNumber s/d paymentProofUrl SAMA)
  invoiceNumber   String   @unique
  customerName    String
  customerPhone   String?
  customerAddress String?
  totalAmount     Int
  shippingFee     Int      @default(0)
  subTotal        Float    @default(0)
  discountPercent Float    @default(0)
  status          String   @default("UNPAID")
  paymentProofUrl String?
  trackingNumber String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relasi Admin & Customer (SAMA)
  createdById     String
  createdBy       User     @relation("AdminCreator", fields: [createdById], references: [id])
  customerId      String?
  customer        User?    @relation("CustomerOwner", fields: [customerId], references: [id])

  // --- [BARU] Relasi ke Affiliate ---
  // Jika invoice ini beli lewat link affiliate, simpan ID-nya di sini
  affiliateId     String?
  affiliate       User?     @relation("AffiliateReferral", fields: [affiliateId], references: [id])

  // Relasi ke tabel komisi (jika sudah cair)
  commission      AffiliateCommission?

  // Relasi ke Item (SAMA)
  items           InvoiceItem[]
}

model InvoiceItem {
  id          String           @id @default(cuid())
  quantity    Int
  priceAtTime Int
  gramasi     Float            @default(0) // Sesuai tabel Anda

  // Relasi
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  invoiceId String
  product   SossilverProduct @relation(fields: [productId], references: [id])
  productId String
}

// Enum untuk Role (Sudah ada di skema Anda)
enum Role {
  ADMIN
  CUSTOMER
}

model PayoutRequest {
  id            String   @id @default(cuid())
  amount        Int
  status        String   @default("PENDING") // PENDING, PROCESSED, REJECTED
  
  bankName      String
  accountNumber String
  accountName   String

  // [BARU] Bukti Transfer dari Admin
  proofUrl      String? 

  affiliateId   String
  affiliate     User     @relation(fields: [affiliateId], references: [id])

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// [DIHAPUS] Enum InvoiceStatus dihapus
// karena Anda menggunakan 'String'